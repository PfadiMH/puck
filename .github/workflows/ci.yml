name: CI/CD

on:
  push:
    branches: [master]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: bunx --bun playwright install --with-deps chromium

      - name: Run tests
        run: SKIP_ENV_VALIDATION=true bun run test --browser.headless

  build-and-health:
    runs-on: ubuntu-latest
    needs: test
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: SKIP_ENV_VALIDATION=true bun run build

      - name: Start application
        env:
          AUTH_SECRET: ci_secret_placeholder
          AUTH_TRUST_HOST: "true"
          INTERNAL_API_BASE_URL: http://localhost:3000
          MONGODB_CONNECTION_STRING: mongodb://localhost:27017/puck_ci
          MONGODB_DB_NAME: puck_ci
        run: bun run start &

      - name: Wait for startup
        run: sleep 20

      - name: Health check
        run: curl -f http://localhost:3000/login

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: build-and-health
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/pfadimh/puck:latest
            ghcr.io/pfadimh/puck:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            docker service update \
              --image ghcr.io/pfadimh/puck:${{ github.sha }} \
              --update-order start-first \
              --update-failure-action rollback \
              --update-delay 10s \
              puck_app

      - name: Clean up old GHCR images
        uses: actions/github-script@v7
        with:
          script: |
            const KEEP = 5;

            const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
              package_type: 'container',
              package_name: 'puck',
              org: context.repo.owner,
              per_page: 100,
            });

            // Filter to only sha-tagged production images (40-char hex, no 'latest', no 'pr-')
            const prodVersions = versions.data.filter(v => {
              const tags = v.metadata?.container?.tags || [];
              return tags.some(t => /^[0-9a-f]{40}$/.test(t)) && !tags.includes('latest');
            });

            // Sort by created_at descending, skip the newest KEEP
            const toDelete = prodVersions
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(KEEP);

            for (const version of toDelete) {
              const tags = version.metadata?.container?.tags || [];
              await github.rest.packages.deletePackageVersionForOrg({
                package_type: 'container',
                package_name: 'puck',
                org: context.repo.owner,
                package_version_id: version.id,
              });
              core.info(`Deleted puck:${tags.join(', ')} (${version.id})`);
            }

            core.info(`Kept ${KEEP} most recent, deleted ${toDelete.length} old images`);
